{% extends 'base.html' %} {% load leaflet_tags %} {% load humanize %} {% load static %} {% block bread %}
<nav class="breadcrumb has-bullet-separator" aria-label="breadcrumbs">
	<ul>
		<li><a href="/" style="color: #9096a1;">Inicio</a></li>
		<li><a href="/dar" style="color: #9096a1;">Información</a></li>
		<li class="is-active">
			<a href="#" class="is-active" style="color: #2979ff;">Quiero ayudar</a>
		</li>
	</ul>
</nav>
{% endblock bread %}
{% block content%}

<div class="title center" style="color: #2979ff; font-weight: bold;">
	Pedidos cercanos {{help_request.id}}
	<div id="loading-indicator" class="loader-wrapper">
		<div class="loader is-loading"></div>
	</div>
</div>

<div class="columns is-centered">
	<div class="column is-6">
		<label class="label has-text-left" for="search-city-field">Buscar tu ciudad</label>
		<div class="row is-centered cities-dropdown-wrapper">
			<div class="columns is-vcentered is-desktop">
				<div class="column">
					<div class="cities-dropdown" role="menu">
						<div class="field is-horizontal">
							<div class="field-body">
								<div class="field">
									<div class="control">
										<div class="select">
											<input
												name="cities"
												class="input"
												role="menuitem"
												list="list_cities"
												id="search-city-field"
												placeholder="Seleccionar ciudad..."
												autocomplete="off"
											/>
										</div>
										<p class="help has-text-info">
											<i
												class="fas fa-info-circle"
												style="font-size: 15px; margin-left: 3px; color: #2979ff;"
											></i
											>&nbsp;&nbsp;Si no ves tu ciudad es porque no hay pedidos!
										</p>
									</div>
								</div>
							</div>
						</div>
						<datalist id="list_cities">
							<select size="10">
								{% for city, code in list_cities %}
								<option data-value="{{code}}">
									{{city}}
								</option>
								{% endfor %}
							</select>
						</datalist>
					</div>
				</div>
			</div>
		</div>

		<div class="row" style="margin-bottom: 5px; border: 1px green solid; border-radius: 2px;">
			{% leaflet_map "main" callback="mainMapInit" %}
		</div>

		<button
			href="#"
			id="find-me"
			class="button is-fullwidth hover-grow"
			style="margin: 30px 0 30px 0; background-color: #236BE4 !important; color: white;"
		>
			<span class="icon is-small">
				<i class="fas fa-map-marker-alt"></i>
			</span>
			<span>Apreta acá, para ver tu ubicación</span>
		</button>
		<p id="status"></p>
	</div>

	<div class="column is-6">
		<label class="label has-text-left" for="search-text-field">Buscar pedidos</label>
		<div class="columns is-vcentered is-desktop">
			<div class="column">
				<div class="field has-addons">
					<div class="control is-expanded">
						<input
							class="input"
							type="text"
							placeholder="Búsqueda por título o descripción, Ejemplo: Pañal"
							id="search-text-field"
							name="search-text-field"
						/>
					</div>
					<div class="control">
						<a
							class="button is-info"
							id="search-button"
							style="border-radius: 5px; background-color: #236BE4; margin-left: 10px;"
						>
							Buscar
						</a>
					</div>
				</div>
			</div>
		</div>
		
		<p
			class="panel-heading has-text-left"
			style="background-color: transparent; color: #ffab07; padding: 5px; margin-bottom: 35px; font-size: 26px !important;"
		>
			Últimos pedidos de ayuda
		</p>
		<div class="panel is-info has-text-left">
			<div style="overflow-y: auto; max-height: 75vh;">
				<div id="requests-table"></div>
			</div>
		</div>
		<div id="requests-table-paginator"></div>
	</div>

	<script type="text/javascript" src="{% static 'scripts/list.js' %}"></script>

	<script type="text/javascript">
		function mainMapInit(map, options) {
			new ListRequestView(map, options);
		}
	</script>

	<script type="text/template" id="requests-table-template">
		     {% verbatim %}
		<a href="/pedidos/{{id}}" class="has-text-grey-dark" title="{{added}}">
			<div class="media">
				<div class="media-content">
					<div class="content">
						<article class="help-request help-request-list">
							<img class="decorative"
									 src="https://argentinaporvos.s3-us-west-2.amazonaws.com/static/img/img_hand.svg" alt="" />
							<div class="media-content">
								<div class="content">
									<p class="bd-notification is-primary has-text-black has-text-left" style="margin-bottom: 0;">
										<strong style="color: #2979ff;">#{{id}}</strong> | {{name}}
									</p>
									<p class="bd-notification is-primary has-text-black has-text-left" style="margin-bottom: 0; color: #a7b0c0 !important;">
										<small class="is-small" style="font-size: 12px;">{{added}}</small>
									</p>
									<p class="bd-notification is-primary has-text-black has-text-left" style="margin-bottom: 0;">
										{{title}}
									</p>
								</div>
							</div>
						</article>
					</div>
				</div>
			</div>
		</a>
		{% endverbatim %}
	</script>

	<script type="text/template" id="requests-table-empty-template">
		     {% verbatim %}
		<div class="media">
		    <h1>No se encuentran pedidos de ayuda en la ubicación actual.</h1>
		</div>
		     {% endverbatim %}
	</script>

	<script type="text/template" id="requests-table-paginator-template">
		{% verbatim %}
		<div class="row requests-table-paginator">

			<nav class="pagination is-centered" role="navigation" aria-label="pagination">
				<button class="pagination-previous prev-button is-outlined" {{hasPrev}} style="background-color: white !important; color: #a7b0c0 !important;"> <i class="fas fa-chevron-left"></i>&nbsp;&nbsp;Anterior</button>

				<ul class="pagination-list">
					<li>
						<button class="pagination-link first-button {{showFirst}} is-outlined" {{hasFirst}} style="background-color: white !important; color: #2979ff; border-color: #2979ff;">1</button>
					</li>

					<li>
						<span class="pagination-ellipsis {{showPrev}} is-outlined">&hellip;</span>
					</li>

					<li>
						<button class="pagination-link current-minus-button {{showPrev}} is-outlined">{{previousPage}} </button>
					</li>

					<li>
						<button class="pagination-link is-current is-outlined">{{currentPage}} </button>
					</li>

					<li>
						<button class="pagination-link current-plus-button {{showNext}} is-outlined">{{nextPage}} </button>
					</li>
					
					<li>
						<span class="pagination-ellipsis {{showNext}} is-outlined">&hellip;</span>
					</li>

					<li>
						<button class="pagination-link last-button {{showLast}} is-outlined" {{hasLast}} style="background-color: white !important; color: #2979ff; border-color: #2979ff;">{{totalPages}}</button>
					</li>
				</ul>

				<button class="pagination-next next-button is-outlined" {{hasNext}} style="background-color: white !important; color: #a7b0c0 !important;">Siguiente&nbsp;&nbsp;<i class="fas fa-chevron-right"></i> </button>
			</nav>
		</div>
		{% endverbatim %}
	</script>

	<script>
			function getDireccion(longitude, latitude) {
				return new Promise(function (resolve, reject) {
					fetch(`/v1/geoinversa/ar/${longitude}/${latitude}`)
						.then((response) => response.json())
						.then((data) => {
							const direccion = data.data;
							document.getElementById('div_direccion').innerHTML = `
          <span><b>Calles</b>:${direccion.getaddress || ''}</span><br /> 
          <span><b>Barrio</b>:${direccion.localidad || ''}</span><br /> 
          <span><b>Ciudad</b>:${direccion.distrito || ''} <span> <span><b>Departamento</b>:${
								direccion.departamento || ''
							}</span>`;
							document.getElementById('id_address').value = `${direccion.direccion || ''} ${
								direccion.localidad || ''
							} ${direccion.distrito || ''} ${direccion.departamento || ''}`;
							resolve(true);
						})
						.catch((error) => {
							resolve(true);
						});
				});
			}

			function geoFindMe() {
				const status = document.querySelector('#status');
				const boton = document.querySelector('#find-me');

				function makePoint(longitude, latitude) {
					return JSON.stringify({
						type: 'Point',
						coordinates: [longitude, latitude],
					});
				}

				async function success(position) {
					const latitude = position.coords.latitude;
					const longitude = position.coords.longitude;

					boton.textContent = 'Te encontré, seguí completando !';
					boton.disabled = true;
					status.textContent = '';

					document.getElementById('id_location').innerHTML = makePoint(longitude, latitude);

					await getDireccion(longitude, latitude);

					const you = L.marker([latitude, longitude], {
						draggable: true,
						opacity: 0.9,
						title: 'Tu ubicación',
					}).addTo(maps[0]);
					you.bindPopup('Moveme si queres !').openPopup();

					maps[0].setView([latitude, longitude], 16);

					you.on('dragend', async function (e) {
						await getDireccion(e.target._latlng.lng, e.target._latlng.lat);
						document.getElementById('id_location').innerHTML = makePoint(
							e.target._latlng.lng,
							e.target._latlng.lat
						);
					});
				}

				function error() {
					status.textContent = 'No puedo encontrarte, usá los botones del mapa';
				}

				if (!navigator.geolocation) {
					status.textContent = 'Tu navegador no soporta la geolocalización';
				} else {
					status.textContent = 'Buscando tu ubicación…';
					navigator.geolocation.getCurrentPosition(success, error);
				}
			}

			function checkRequestForm() {
				fields = ['id_title', 'id_message', 'id_name', 'id_phone', 'id_location', 'id_address'];
				var valid = true;
				for (field in fields) {
					if (!document.getElementById(fields[field]).checkValidity()) {
						valid = false;
					}
				}

				if (valid) {
					document.querySelector('#submit').textContent = 'Enviando...';
					document.querySelector('#submit').disabled = 'disabled';
					return true;
				}
			}

			document.querySelectorAll('.modal-button').forEach(function (el) {
				el.addEventListener('click', function () {
					var target = document.querySelector(el.getAttribute('data-target'));
					//map.invalidateSize();
					target.classList.add('is-active');

					target.querySelector('.close').addEventListener('click', function () {
						target.classList.remove('is-active');
					});
					target.querySelector('.delete').addEventListener('click', function () {
						target.classList.remove('is-active');
					});
					target.querySelector('.modal-background').addEventListener('click', function () {
						target.classList.remove('is-active');
					});
				});
			});

			document.querySelector('#find-me').addEventListener('click', geoFindMe);
		</script>


	{% endblock %}
</div>
